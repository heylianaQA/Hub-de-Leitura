name: Cypress Tests

on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Instalar dependências da aplicação
        working-directory: hub-de-leitura-integrado
        run: npm install

      - name: Inicializar banco de dados
        working-directory: hub-de-leitura-integrado
        run: node scripts/init_db.js

      - name: Rodar setup da aplicação
        working-directory: hub-de-leitura-integrado
        run: node setup.js

      - name: Subir aplicação em background
        working-directory: hub-de-leitura-integrado
        run: node src/server.js > /tmp/app.log 2>&1 &

      - name: Aguardar aplicação iniciar
        run: |
          echo "Aguardando servidor subir..."
          sleep 20
          echo "=== LOG DA APLICAÇÃO ==="
          cat /tmp/app.log
          echo "========================"
          curl --retry 10 --retry-delay 3 --retry-connrefused http://localhost:3000 || echo "Servidor não respondeu"

      - name: Instalar dependências dos testes
        run: npm ci

      - name: Instalar binário do Cypress
        run: ./node_modules/.bin/cypress install

      - name: Executar testes Cypress
        run: ./node_modules/.bin/cypress run